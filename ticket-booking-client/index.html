<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Главная страница</title>
  <style>
    .main-container {
      display: flex;
      gap: 2rem;
      padding: 20px;
    }
    .left-column {
      flex: 1;
    }
    .right-column {
      flex: 1;
      border-left: 1px solid #ccc;
      padding-left: 20px;
    }
    .form-container {
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .ticket {
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #eee;
    }
    .pagination {
      margin-top: 10px;
    }
    .datetime-input {
      width: 100%;
    }
    header {
      background-color: #333;
      color: white;
      padding: 10px 20px;
      text-align: center;
    }
    header nav a {
      color: white;
      text-decoration: none;
      margin: 0 15px;
      font-size: 18px;
    }
    header nav a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
      <nav>
          <a href="/">Главная</a>
          <a href="/auth">Регистрация</a>
          <a href="/me">Личный кабинет</a>
          <a href="/booking">Активные брони</a>
      </nav>
  </header>

  <div class="main-container">
    <!-- Левая колонка: формы поиска -->
    <div class="left-column">
      <div class="form-container">
        <h2>Поиск билетов</h2>
        <form id="ticketSearchForm">
          <div class="form-group">
            <label for="ticket-from">Откуда:</label>
            <input type="text" id="ticket-from" name="from" required>
          </div>
          <div class="form-group">
            <label for="ticket-to">Куда:</label>
            <input type="text" id="ticket-to" name="to" required>
          </div>
          <div class="form-group">
            <label for="ticket-type">Тип транспорта:</label>
            <select id="ticket-type" name="type">
              <option value="">-- Не выбрано --</option>
              <option value="avia">avia</option>
              <option value="bus">bus</option>
              <option value="train">train</option>
            </select>
          </div>
          <div class="form-group">
            <label for="ticket-startTime">Начало интервала:</label>
            <input type="text" id="ticket-startTime" class="datetime-input" name="startTime"
                   placeholder="дд.мм.гггг чч:мм" title="Формат: дд.мм.гггг чч:мм">
          </div>
          <div class="form-group">
            <label for="ticket-endTime">Конец интервала:</label>
            <input type="text" id="ticket-endTime" class="datetime-input" name="endTime"
                   placeholder="дд.мм.гггг чч:мм" title="Формат: дд.мм.гггг чч:мм">
          </div>
          <button type="submit">Поиск билетов</button>
        </form>
      </div>

      <div class="form-container">
        <h2>Поиск ближайших маршрутов</h2>
        <form id="closestRouteSearchForm">
          <div class="form-group">
            <label for="closest-from">Откуда:</label>
            <input type="text" id="closest-from" name="from" required>
          </div>
          <div class="form-group">
            <label for="closest-to">Куда:</label>
            <input type="text" id="closest-to" name="to" required>
          </div>
          <div class="form-group">
            <label for="closest-desiredDepartureTime">Время отправления:</label>
            <input type="text" id="closest-desiredDepartureTime" class="datetime-input" 
                   name="desiredDepartureTime" required 
                   placeholder="дд.мм.гггг чч:мм" title="Формат: дд.мм.гггг чч:мм">
          </div>
          <button type="submit">Поиск маршрутов</button>
        </form>
      </div>
    </div>

    <!-- Правая колонка: результаты (билеты) -->
    <div class="right-column">
      <h2>Результаты поиска</h2>
      <!-- Результаты поиска билетов -->
      <div id="ticketSearchResults"></div>
      <div id="ticketPagination" class="pagination"></div>
      <!-- Результаты поиска ближайших маршрутов -->
      <div id="closestRouteSearchResults"></div>
      <div id="closestPagination" class="pagination"></div>
    </div>
  </div>

  <script>
    const apiBaseUrl = "http://localhost:8080"; // Новый базовый URL API

    // Глобальные переменные для сохранения параметров поиска и курсоров
    let ticketSearchParams = null;
    let ticketCursorDepartureTime = null;
    let ticketCursorId = null;

    let closestSearchParams = null;
    let closestCursorDepartureTime = null;
    let closestCursorId = null;

    // Функция для парсинга пользовательской даты формата "дд.мм.гггг чч:мм"
    function parseLocalDateTime(inputValue) {
      if (!inputValue) return null;
      const dateRegex = /^(\d{2})\.(\d{2})\.(\d{4}) (\d{2}):(\d{2})$/;
      const match = inputValue.match(dateRegex);
      if (!match) {
        alert('Формат даты: дд.мм.гггг чч:мм');
        console.log('Неверный формат даты:', inputValue);
        return null;
      }
      const [, day, month, year, hours, minutes] = match;
      const localDate = new Date(
        parseInt(year),
        parseInt(month) - 1,
        parseInt(day),
        parseInt(hours),
        parseInt(minutes)
      );
      if (isNaN(localDate.getTime())) {
        alert('Некорректная дата');
        console.log('Некорректная дата:', inputValue);
        return null;
      }
      // Преобразование в ISO-8601 с временной зоной (UTC)
      const adjustedDate = new Date(localDate.getTime() - (localDate.getTimezoneOffset() * 60000));
      const isoString = adjustedDate.toISOString().replace(/\..+/, 'Z');
      console.log('Преобразованная дата', inputValue, '->', isoString);
      return isoString;
    }

    // Инициализация полей даты: автоформатирование ввода
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.datetime-input').forEach(input => {
        input.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          let formatted = '';
          const parts = [
            value.slice(0,2),  // день
            value.slice(2,4),  // месяц
            value.slice(4,8),  // год
            value.slice(8,10), // часы
            value.slice(10,12) // минуты
          ];
          formatted = parts[0] +
            (parts[1] ? '.' + parts[1] : '') +
            (parts[2] ? '.' + parts[2] : '') +
            (parts[3] ? ' ' + parts[3] : '') +
            (parts[4] ? ':' + parts[4] : '');
          e.target.value = formatted;
        });
      });
    });

    // Работа с токенами
    function getAccessToken() {
      return localStorage.getItem('accessToken');
    }

    async function refreshAccessToken() {
      const refreshToken = localStorage.getItem('refreshToken');
      if (!refreshToken) {
        console.log('Нет refreshToken, перенаправление на /auth');
        window.location.href = '/auth';
        return;
      }
      try {
        console.log('Отправка запроса на обновление токена');
        const response = await fetch(`${apiBaseUrl}/auth/refresh`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refreshToken })
        });
        if (!response.ok) {
          console.log('Ошибка обновления токена, статус:', response.status);
          window.location.href = '/auth';
          return;
        }
        const data = await response.json();
        console.log('Токен успешно обновлён:', data);
        localStorage.setItem('accessToken', data.accessToken);
        return data.accessToken;
      } catch (error) {
        console.error('Ошибка обновления токена:', error);
        window.location.href = '/auth';
      }
    }

    // Функция создания бронирования
    async function createBooking(ticketId, ticketQuantity) {
      if (ticketQuantity <= 0) {
        alert("Количество должно быть больше нуля");
        return;
      }
      let accessToken = getAccessToken();
      if (!accessToken) {
        console.log('Нет accessToken, перенаправление на /auth');
        window.location.href = '/auth';
        return;
      }
      try {
        console.log(`Отправка запроса на бронирование: билет ${ticketId}, количество ${ticketQuantity}`);
        let response = await fetch(`${apiBaseUrl}/bookings/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + accessToken
          },
          body: JSON.stringify({ ticketId, ticketQuantity })
        });
        if (response.status === 401) {
          const errorData = await response.json();
          console.log('Ошибка 401 при бронировании:', errorData);
          if (errorData.code === 'TOKEN_EXPIRED') {
            accessToken = await refreshAccessToken();
            response = await fetch(`${apiBaseUrl}/bookings/create`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + accessToken
              },
              body: JSON.stringify({ ticketId, ticketQuantity })
            });
          } else {
            window.location.href = '/auth';
            return;
          }
        }
        if (response.ok) {
          console.log('Бронирование успешно создано');
          alert('Бронирование создано!');
        } else {
          const errorData = await response.json();
          console.log('Ошибка при создании бронирования:', errorData);
          alert('Ошибка: ' + errorData.message);
        }
      } catch (error) {
        console.error('Ошибка при бронировании:', error);
        alert('Ошибка соединения');
      }
    }

    // Функция для отображения билетов; если append==false – заменяет содержимое, иначе добавляет в конец
    function renderTickets(containerId, tickets, append = false) {
      const container = document.getElementById(containerId);
      if (!append) {
        container.innerHTML = '';
      }
      tickets.forEach(ticket => {
        const ticketDiv = document.createElement('div');
        ticketDiv.className = 'ticket';
        ticketDiv.innerHTML = `
          <p>Билет ID: ${ticket.id}</p>
          <p>Тип транспорта: ${ticket.transportType}</p>
          <p>Откуда: ${ticket.departureCity}</p>
          <p>Куда: ${ticket.arrivalCity}</p>
          <p>Время отправления: ${new Date(ticket.departureTime).toLocaleString()}</p>
          <p>Время прибытия: ${new Date(ticket.arrivalTime).toLocaleString()}</p>
          <p>Цена: ${ticket.price}</p>
          <p>Доступно: ${ticket.availableTickets}</p>
          <label>Количество: 
            <input type="number" min="1" value="1" class="ticketQuantity">
          </label>
          <button class="bookingButton" data-ticket-id="${ticket.id}">Забронировать</button>
          <hr>
        `;
        container.appendChild(ticketDiv);
      });
      container.querySelectorAll('.bookingButton').forEach(button => {
        button.addEventListener('click', (e) => {
          const ticketId = e.target.dataset.ticketId;
          const quantity = parseInt(e.target.parentElement.querySelector('input[type="number"]').value);
          createBooking(ticketId, quantity);
        });
      });
      console.log(`Отображено ${tickets.length} билетов в контейнере "${containerId}"`);
    }

    // Функция для обновления блока пагинации с кнопкой "Следующая страница"
    function updatePagination(paginationContainerId, fetchNextCallback) {
      const container = document.getElementById(paginationContainerId);
      container.innerHTML = '';
      const btn = document.createElement('button');
      btn.textContent = "Следующая страница";
      btn.addEventListener('click', fetchNextCallback);
      container.appendChild(btn);
      console.log('Обновлена пагинация в контейнере', paginationContainerId);
    }

    // Обработчик формы поиска билетов
    document.getElementById('ticketSearchForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      // Создаем объект параметров с обязательными полями "from" и "to"
      ticketSearchParams = {
        from: formData.get('from'),
        to: formData.get('to'),
        pageSize: 10
      };
      // Если пользователь указал тип транспорта, дату начала или дату конца, добавляем в запрос
      const typeValue = formData.get('type');
      if (typeValue && typeValue.trim() !== "") {
        ticketSearchParams.type = typeValue;
      }
      const startTimeValue = formData.get('startTime');
      const parsedStartTime = parseLocalDateTime(startTimeValue);
      if (parsedStartTime) {
        ticketSearchParams.startTime = parsedStartTime;
      }
      const endTimeValue = formData.get('endTime');
      const parsedEndTime = parseLocalDateTime(endTimeValue);
      if (parsedEndTime) {
        ticketSearchParams.endTime = parsedEndTime;
      }
      console.log('Параметры поиска билетов:', ticketSearchParams);
      try {
        const response = await fetch(`${apiBaseUrl}/tickets/search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(ticketSearchParams)
        });
        console.log('Запрос на поиск билетов отправлен');
        if (response.ok) {
          const data = await response.json();
          console.log('Ответ на поиск билетов:', data);
          renderTickets('ticketSearchResults', data.tickets, false);
          ticketCursorDepartureTime = data.nextCursorDepartureTime;
          ticketCursorId = data.nextCursorId;
          if (ticketCursorDepartureTime && ticketCursorId !== null) {
            updatePagination('ticketPagination', fetchNextTicketPage);
          } else {
            document.getElementById('ticketPagination').innerHTML = '';
            console.log('Больше билетов не найдено');
          }
        } else {
          const errorData = await response.json();
          console.error('Ошибка поиска билетов:', errorData);
          alert('Ошибка: ' + errorData.message);
        }
      } catch (error) {
        console.error('Ошибка соединения при поиске билетов:', error);
        alert('Ошибка соединения');
      }
    });

    // Функция для загрузки следующей страницы билетов
    async function fetchNextTicketPage() {
      if (!ticketSearchParams || !ticketCursorDepartureTime || ticketCursorId === null) return;
      const nextPageRequestData = {
        ...ticketSearchParams,
        lastDepartureTime: ticketCursorDepartureTime,
        lastId: ticketCursorId,
        pageSize: 10
      };
      console.log('Запрос на следующую страницу билетов:', nextPageRequestData);
      try {
        const response = await fetch(`${apiBaseUrl}/tickets/search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(nextPageRequestData)
        });
        console.log('Запрос на следующую страницу билетов отправлен');
        if (response.ok) {
          const data = await response.json();
          console.log('Ответ на следующую страницу билетов:', data);
          renderTickets('ticketSearchResults', data.tickets, true);
          ticketCursorDepartureTime = data.nextCursorDepartureTime;
          ticketCursorId = data.nextCursorId;
          if (ticketCursorDepartureTime && ticketCursorId !== null) {
            updatePagination('ticketPagination', fetchNextTicketPage);
          } else {
            document.getElementById('ticketPagination').innerHTML = '';
            console.log('Пагинация завершена, больше билетов не найдено');
          }
        } else {
          const errorData = await response.json();
          console.error('Ошибка следующей страницы билетов:', errorData);
          alert('Ошибка: ' + errorData.message);
        }
      } catch (error) {
        console.error('Ошибка соединения при загрузке следующей страницы билетов:', error);
        alert('Ошибка соединения');
      }
    }

    // Обработчик формы поиска ближайших маршрутов
    document.getElementById('closestRouteSearchForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      closestSearchParams = {
        from: formData.get('from'),
        to: formData.get('to'),
        desiredDepartureTime: parseLocalDateTime(formData.get('desiredDepartureTime')),
        pageSize: 5
      };
      console.log('Параметры поиска ближайших маршрутов:', closestSearchParams);
      try {
        const response = await fetch(`${apiBaseUrl}/tickets/closest-search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(closestSearchParams)
        });
        console.log('Запрос на поиск ближайших маршрутов отправлен');
        if (response.ok) {
          const data = await response.json();
          console.log('Ответ на поиск ближайших маршрутов:', data);
          renderTickets('closestRouteSearchResults', data.tickets, false);
          closestCursorDepartureTime = data.nextCursorDepartureTime;
          closestCursorId = data.nextCursorId;
          if (closestCursorDepartureTime && closestCursorId !== null) {
            updatePagination('closestPagination', fetchNextClosestPage);
          } else {
            document.getElementById('closestPagination').innerHTML = '';
            console.log('Больше маршрутов не найдено');
          }
        } else {
          const errorData = await response.json();
          console.error('Ошибка поиска маршрутов:', errorData);
          alert('Ошибка: ' + errorData.message);
        }
      } catch (error) {
        console.error('Ошибка соединения при поиске маршрутов:', error);
        alert('Ошибка соединения');
      }
    });

    // Функция для загрузки следующей страницы для ближайших маршрутов
    async function fetchNextClosestPage() {
      if (!closestSearchParams || !closestCursorDepartureTime || closestCursorId === null) return;
      const nextPageRequestData = {
        ...closestSearchParams,
        lastDepartureTime: closestCursorDepartureTime,
        lastId: closestCursorId,
        pageSize: 5
      };
      console.log('Запрос на следующую страницу маршрутов:', nextPageRequestData);
      try {
        const response = await fetch(`${apiBaseUrl}/tickets/closest-search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(nextPageRequestData)
        });
        console.log('Запрос на следующую страницу маршрутов отправлен');
        if (response.ok) {
          const data = await response.json();
          console.log('Ответ на следующую страницу маршрутов:', data);
          renderTickets('closestRouteSearchResults', data.tickets, true);
          closestCursorDepartureTime = data.nextCursorDepartureTime;
          closestCursorId = data.nextCursorId;
          if (closestCursorDepartureTime && closestCursorId !== null) {
            updatePagination('closestPagination', fetchNextClosestPage);
          } else {
            document.getElementById('closestPagination').innerHTML = '';
            console.log('Пагинация маршрутов завершена, больше результатов не найдено');
          }
        } else {
          const errorData = await response.json();
          console.error('Ошибка следующей страницы маршрутов:', errorData);
          alert('Ошибка: ' + errorData.message);
        }
      } catch (error) {
        console.error('Ошибка соединения при загрузке следующей страницы маршрутов:', error);
        alert('Ошибка соединения');
      }
    }
  </script>
</body>
</html>
